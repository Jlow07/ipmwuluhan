<!DOCTYPE html>
<html lang="en"> 
<head>
    <title>Musyawarah Cabang : IKATAN PELAJAR MUHAMMADIYAH WULUHAN</title>
    
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Pemilihan Calon Pimpinan CABANG IKATAN PELAJAR MUHAMMADIYAH WULUHAN>
    <meta name="author" content="PIMPINAN CABANG IKATAN PELAJAR MUHAMMADIYAH WULUHAN">    
    <link rel="shortcut icon" href="pngwing.com.png"> 
    
    <!-- Google Font -->
    <!-- FontAwesome JS-->
    <script src="moment-with-locales.js"></script>
    
    <!-- Theme CSS -->  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
     <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
    <link href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css" rel="stylesheet">
    <style>


body {
  background-image: url("bg.webp");
  background-repeat: repeat;
}

.grayscale{
  -webkit-filter: grayscale(50%); filter: grayscale(50%);
}

      .nopad {
	padding-left: 0 !important;
	padding-right: 0 !important;
}
/*image gallery*/
.image-checkbox {
  border-radius: 10px;
	cursor: pointer;
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	border: 1px solid #000;
	margin-bottom: 0;
	outline: 0;
}
.image-checkbox input[type="checkbox"] {
	display: none;
}

.image-checkbox-checked {
  border: 4px solid #2ECC71;
  background-color: #c5ddf3;
}
.image-checkbox .fa {
  position: absolute;
  color: #fff;
  background-color: #2ECC71;
  padding: 10px;
  border-radius: 0px 0px 10px 10px;
  top: 0;
  right: 10px;
  display: none;
}
.image-checkbox-checked .fa {
  display: block !important;
}


#button-background {
	 position: relative;
	 background-color: #E5E7E9;
	 width: 280px;
	 height: 50px;
	 border: white;
	 border-radius: 40px;
	 display: flex;
	 align-items: center;
	 justify-content: center;
}
 #slider {
	 transition: width 0.3s, border-radius 0.3s, height 0.3s;
	 position: absolute;
   background-color: #2ECC71;
	 left: -10px;
	 width: 70px;
	 height: 70px;
	 border-radius: 50%;
	 display: flex;
	 align-items: center;
	 justify-content: center;
}
#slider.inactive{
  background-color: #909497;
}
 #slider.unlocked {
	 transition: all 0.3s;
	 width: inherit;
	 left: 0 !important;
	 height: inherit;
	 border-radius: inherit;
}

 .slide-text {
	 color: #3a3d55;
	 font-size: 24px;
	 text-transform: uppercase;
	 font-family: 'Roboto', sans-serif;
	 -webkit-touch-callout: none;
	 -webkit-user-select: none;
	 -khtml-user-select: none;
	 -moz-user-select: none;
	 -ms-user-select: none;
	 user-select: none;
	 cursor: default;
}
 .bottom {
	 position: fixed;
	 bottom: 0;
	 font-size: 14px;
	 color: white;
}
 .bottom a {
	 color: white;
}

.chart {
  max-height: 500px;
}

 
    </style>

        
</head> 

<body>
  <nav class="navbar bg-body-tertiary bg-dark" data-bs-theme="dark">
    <div class="container-fluid">
      <div class="navbar-brand text-light">
        <div class="d-lg-none"><img src="logocabwul.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top">
          <span class="fw-bold">Musyawarah Cabang XXIII</span></div>
        <div class="d-none d-lg-block"><img src="logocabwul.png" alt="Logo" width="35" height="35" class="d-inline-block align-text-top">
          <span class="fw-bold">Musyawarah Cabang XXIII: </span>
          PIMPINAN CABANG IKATAN PELAJAR MUHAMMADIYAH WULUHAN</div>
        
      </div>
      <div class="d-flex">
        <button class="btn btn-outline-warning d-none" style="margin-right: 5px;" id="dashboard-button"><i class="fa fa-chevron-left" aria-hidden="true"></i> Kembali</button>
        <button class="btn btn-outline-danger d-none" id="logout-button" title="Keluar"><i class="fa fa-power-off" aria-hidden="true"></i></button>
        
      </div>
    </div>
  </nav>

  <section id="result-section" class="d-none mb-3">

    <div class="container mt-3">
      <div class="row mb-3">
        <div id="result-title"></div>
        <i class="fw-bold" id="result-time"></i>
        <div>
          <input type="text" id="nama-organisasi" class="d-none" disabled/>
          <button onclick="getHasil(document.getElementById('nama-organisasi').value);" class="btn btn-dark mt-2"><i class="fa fa-refresh" aria-hidden="true"></i> Perbarui</button>
          <button onclick="exportTableToExcel('tabel-hasil', document.getElementById('result-time').innerText)" class="btn btn-success mt-2"><i class="fa fa-cloud-download" aria-hidden="true"></i> Unduh .xls</button>
        </div>
      </div>
      <div class="row">
    
        <nav>
          <div class="nav nav-tabs mb-3" id="nav-tab" role="tablist">
            
            <button class="nav-link active" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#nav-diagram" type="button" role="tab" aria-controls="nav-diagram" aria-selected="true">Diagram</button>
            <button class="nav-link" id="tabel-tab" data-bs-toggle="tab" data-bs-target="#nav-tabel" type="button" role="tab" aria-controls="nav-tabel" aria-selected="false">Tabel</button>
            <button class="nav-link" id="ikhtisar-tab" data-bs-toggle="tab" data-bs-target="#nav-ikhtisar" type="button" role="tab" aria-controls="nav-ikhtisar" aria-selected="true">Ikhtisar</button>
          </div>
          <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show" id="nav-ikhtisar" role="tabpanel" aria-labelledby="ikhtisar-tab">


              <div class="container text-center justify-content-center"> 
                <table id="tabel-ikhtisar" class="bg-white">
  <thead class="text-center bg-light">
    <tr>
      <th data-field="jumlahcalon" data-sortable="false" class="col">Jumlah Calon</th>
      <th data-field="jumlahpemilih" data-sortable="false" class="col">Jumlah Pemilih</th>
      <th data-field="sudahmemilih" data-sortable="false" class="col">Sudah Memilih</th>
      <th data-field="belummemilih" data-sortable="false" class="col">Belum Memilih</th>
      <th data-field="partisipasipemilih" data-sortable="false" class="col">Partisipasi Pemilih</th>
    </tr>
  </thead>
</table>
                </div>

            </div>
            <div class="tab-pane fade show active" id="nav-diagram" role="tabpanel" aria-labelledby="diagram-tab">
              <div class="chart text-center d-flex justify-content-center" id="chart-canvas"></div>
            </div>
            <div class="tab-pane fade" id="nav-tabel" role="tabpanel" aria-labelledby="tabel-tab">
              <div class="form-check form-switch m-3">
                <input class="form-check-input" type="checkbox" role="switch" id="check-foto" onclick="switchFoto()" checked>
                </div>
              <div class="container text-center justify-content-center">
                <table id="tabel-hasil" class="bg-white"
  data-sort-priority='[{"sortName": "nama-mu","sortOrder":"asc"},{"sortName":"hasil-mu","sortOrder":"desc"}]'>
  <thead class="text-center bg-light">
    <tr>
      <th data-field="urut" data-sortable="true" class="col-1">No.</th>
      <th data-field="foto" data-sortable="false" class="col-2">Foto</th>
      <th data-field="nama" data-sortable="true" class="col-4">Nama</th>
      <th data-field="nbm" data-sortable="false" class="col-2"><span id="nbm-tabel"></span></th>
      <th data-field="asal" data-sortable="true" class="col-3">Asal</th>
      <th data-field="hasil" data-sortable="true" class="col-2">Hasil</th>
    </tr>
  </thead>
</table>


                </div>
            </div>
          </div>
        </nav>

    
    </section>


<section id="election-section" class="d-none mb-3">
  <nav class="navbar bg-body-tertiary sticky-top invisible" id="indicator-navbar" style="background-color: #F9E79F;" data-bs-theme="dark">
    <div class="container-fluid text-center d-flex justify-content-center">
      <div class="w-75">
        <div class="d-flex justify-content-left text-left fw-bold" id="indicator-text"></div>
        <div class="progress" role="progressbar" aria-label="Example with label"  style="height: 25px; border-radius:50px;">
          <div class="progress-bar" style="background-color: #F1C40F;" id="indicator-progress"></div>
        </div>
      </div>
  </nav>

<div id="login-1">
    <div><input type="text" id="kode-pemilih" class="d-none" disabled/></div>
    <div><input type="text" id="organisasi" class="d-none" disabled/></div>
</div>

<div class="container overflow-hidden mt-3">
  <div class="row text-center">
    <div class="text-center mb-2" id="title">
  </div></div>
  <div id="daftar-pilihan" class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-2 text-center justify-content-center">
  </div>

  <div class="row text-center justify-content-center mt-5 invisible" id="election-submit" style="height: 100px">
    <div id="button-background">
      <span class="slide-text fw-bold" style="padding-left: 25px;">Geser&nbsp;&nbsp;<i class="fa fa-chevron-right fa-1x" aria-hidden="true"></i></span>
      <div id="slider">
        <i class="fa fa-lock fa-2x" id="locker" aria-hidden="true"></i>
      </div>
    </div>
    <div class="text-center d-flex justify-content-center mt-2 mb-2" id="user-info"></div>
  </div>

  
</div>
</section>


</body>
<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
<script src="https://cdn.jsdelivr.net/jsbarcode/3.3.20/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.4/dist/extensions/multiple-sort/bootstrap-table-multiple-sort.js"></script>




<script>

window.onload =  getUrlHasil();
$("#dashboard-button").attr('onClick', 'goDashboard()');
$("#logout-button").attr('onClick', 'location.reload()');

var must; //minimal pilihan
    var jumlahPilihanMu = 9; //9
    var jumlahPilihanAi = 9; //7

    function switchFoto() {
    
  if ($('#check-foto').is(":checked")){
    $('#tabel-hasil').bootstrapTable('showColumn', 'foto');
    var nbmText;
if ($('#nama-organisasi').val().toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
 nbmText = 'NBA.';} else {
  nbmText = 'NBA.'
    }
  
  $('#nbm-tabel').html(nbmText);
    
  } else {
    $('#tabel-hasil').bootstrapTable('hideColumn', 'foto');
    var nbmText;
if ($('#nama-organisasi').val().toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
 nbmText = 'NBA.';} else {
  nbmText = 'NBA.'
    }
  
  $('#nbm-tabel').html(nbmText);
  }

    }

function exportTableToExcel(tableID, filename = ''){
    var downloadLink;
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById(tableID);
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    
    // Specify file name
    filename = filename?filename+'.xls':'excel_data.xls';
    
    // Create download link element
    downloadLink = document.createElement("a");
    
    document.body.appendChild(downloadLink);
    
    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['\ufeff', tableHTML], {
            type: dataType
        });
        navigator.msSaveOrOpenBlob( blob, filename);
    }else{
        // Create a link to the file
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
    
        // Setting the file name
        downloadLink.download = filename;
        
        //triggering the function
        downloadLink.click();
    }
}

$(function() {
    $('#tabel-hasil').bootstrapTable();
    $('#tabel-ikhtisar').bootstrapTable()
  })

function getHasil(org) {
var org = org;
  $('#result-section').removeClass('d-none');
  $('#nama-organisasi').val(org);
  $('#chart-canvas').html('<canvas id="chart"></canvas>')

  let ctx = document.getElementById("chart").getContext("2d");

$('#result-title').html('<h4>Hasil Rekapitulasi Pemilihan Calon Formatur Pimpinan Cabang'+ org +' Wuluhan</h4><h4>Periode 2024-2026</h4>');
moment.locale('id');
$('#result-time').html('Diperbarui: ' + moment().format('DD MMM YYYY HH.mm'));

fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/IKHTISAR")
  .then((response) => response.json())
  .then((data) => {

    const filterOrg1 = {"ORGANISASI": org}

const filteredOutput1 = data.filter( obj => {
  return Object.keys(filterOrg1).every( filterKeys => {
    return obj[filterKeys] === filterOrg1[filterKeys]
  });
}); 

var data1 = filteredOutput1.sort((a, b) => Number(a.URUT) - Number(b.URUT));



var dataTabelikhtisar = [];

dataTabelikhtisar.push({
        jumlahcalon: data1[0].JUMLAHCALON,
        jumlahpemilih: data1[0].JUMLAHPEMILIH,
        sudahmemilih: data1[0].SUDAHMEMILIH,
        belummemilih: data1[0].BELUMMEMILIH,
        partisipasipemilih: data1[0].PARTISIPASIPEMILIH + ' %',
    })

    $('#tabel-ikhtisar').bootstrapTable('load', dataTabelikhtisar);

  })
  .catch((error) => {
    console.error(error);
  });

  
  fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/PILIHAN")
  .then((response) => response.json())
  .then((data) => {
   const filterOrg = {"ORGANISASI": org}
const filteredOutput = data.filter( obj => {
  return Object.keys(filterOrg).every( filterKeys => {
    return obj[filterKeys] === filterOrg[filterKeys]
  });
});

   var data = filteredOutput.sort((a, b) => Number(a.URUT) - Number(b.URUT));


   

  
   var dataTabelHasil = [];

   

   for (var i = 0; i < data.length; i++) {
    dataTabelHasil.push({
      urut: data[i].URUT,
      foto: `<img src="`+ data[i].FOTO +`" class="img-thumbnail" style="aspect-ratio: 1 / 1; object-fit: cover;">`,
        nama: data[i].NAMA,
        nbm: data[i].NBA,
        asal: data[i].ASAL,
        hasil: data[i].HASIL
    })
  }

var nbmText;
if (org.toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
 nbmText = 'NBA.';} else {
  nbmText = 'NBA.'
    }
  

  $('#nbm-tabel').html(nbmText);
  $('#tabel-hasil').bootstrapTable('load', dataTabelHasil);


  var namaChart = [];
  var hasilChart = [];

   for (var i = 0; i < data.length; i++) {
    namaChart.push(data[i].NAMA);
    hasilChart.push(data[i].HASIL);
  }

Chart.defaults.backgroundColor = '#9BD0F5';
Chart.defaults.borderColor = '#000';
Chart.defaults.color = '#000';

let chart = new Chart(ctx, {
  type: "bar",
  data: {
	 labels: namaChart,
	 datasets: [
		{
		  label: "Jumlah Suara",
		  data: hasilChart
		}
	 ]
  },
  options: {
        scales: {
            x: {
                ticks: {
                  
                    minRotation: 45
                }
            }
        }
    }
});



  })
  .catch((error) => {
    console.error(error);
  });
  


}







var initialMouse = 0;
var slideMovementTotal = 0;
var mouseIsDown = false;
var slider = $('#slider');

slider.on('mousedown touchstart', function(event){
	mouseIsDown = true;
	slideMovementTotal = $('#button-background').width() - $(this).width() + 10;
	initialMouse = event.clientX || event.originalEvent.touches[0].pageX;
});

$(document.body, '#slider').on('mouseup touchend', function (event) {
	if (!mouseIsDown)
		return;
	mouseIsDown = false;
	var currentMouse = event.clientX || event.changedTouches[0].pageX;
	var relativeMouse = currentMouse - initialMouse;
  
	if (relativeMouse < slideMovementTotal) {
		$('.slide-text').fadeTo(300, 1);
		slider.animate({
			left: "-10px"
		}, 300);
		return;
	}
  if (!slider.hasClass('unlocked') && !slider.hasClass('inactive')) {
    editPilihan();
  	slider.addClass('unlocked');
	$('#locker').className('fa fa-lock fa-2x');
} 

});

$(document.body).on('mousemove touchmove', function(event){
	if (!mouseIsDown)
		return;
    if(!slider.hasClass('inactive')) {
	var currentMouse = event.clientX || event.originalEvent.touches[0].pageX;
	var relativeMouse = currentMouse - initialMouse;
 
    var slidePercent = 1 - (relativeMouse / slideMovementTotal);
  }
	
	
	$('.slide-text').fadeTo(0, slidePercent);

	if (relativeMouse <= 0) {
		slider.css({'left': '-10px'});
		return;
	}
	if (relativeMouse >= slideMovementTotal + 10) {
		slider.css({'left': slideMovementTotal + 'px'});
		return;
	}
	slider.css({'left': relativeMouse - 10});
});



function getUrlHasil() {
    const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const org = urlParams.get('hasil')

if (org) {

  if(org == "Muhammadiyah" || org == "Aisyiyah" ) {
    getHasil(org);
  } else {
    loginAlert()
  }
} else {
  loginAlert()
}
        }

function goDashboard(bio) {

  $('#dashboard-button').addClass('d-none');
  $('#logout-button').addClass('d-none');
  $('#election-section').addClass('d-none');
  $('#result-section').addClass('d-none');

//console.log(bio)
var biodataPemilih = [];
var kodePemilih = $('#kode-pemilih').val();

if (!bio) {
fetch(`https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/PEMILIH`)
    .then((response) => response.json()).then((data) => {
    var pemilih = data.find( ({ KODE }) => KODE === kodePemilih );

    openDashboard(pemilih) 
      })
      .catch(error => { console.log(error)
      })

} else {
  //biodataPemilih = bio;
  openDashboard(bio) 
}

}

function openDashboard(bio) {
  var biodataPemilih = bio;

    
  fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/DATA")
  .then((response) => response.json())
  .then((data) => {
    var data = data.find( ({ PEMILIH }) => PEMILIH === biodataPemilih.KODE );
    var waktuMemilih = data['WAKTU'];

    semuapilihan.push(
    data['PILIHAN1'],
    data['PILIHAN2'],
    data['PILIHAN3'],
    data['PILIHAN4'],
    data['PILIHAN5'],
    data['PILIHAN6'],
    data['PILIHAN7'],
    data['PILIHAN8'],
    data['PILIHAN9'],
    );

    $(document).ready(function() {
  setTimeout(function() { 
    
$('#div-barcode').html('<svg id="barcode"></svg>');
$("#barcode").JsBarcode(biodataPemilih.KODE, {  height: 40,
});
  }, 1000); // for 5 second delay d
});


var timerLogout = 0;
moment.locale('id');
if (waktuMemilih == moment().format('DD MMM YYYY HH.mm')) {
  timerLogout = 20000;
}
var timerProgressBarLogout = true;

    Swal.fire({
  title: 'Biodata Pemilih',
  html: `<div class="container" id="div-barcode"><div class="spinner-grow" role="status">
  <span class="sr-only">Loading...</span>
</div></div><div class="container table-responsive"> 
<table class="table table-bordered table-hover text-center">
  <tbody>
    <tr>
      <td>Nama</th>
      <td>`+ biodataPemilih.NAMA +`</td>
    </tr>
    <tr>
      <td>NBA</th>
      <td>`+ biodataPemilih.NBA +`</td>
    </tr>
    <tr>
      <td>Organisasi</th>
      <td>`+ biodataPemilih.ORGANISASI +`</td>
    </tr>
     <tr>
      <td>Utusan</th>
      <td>`+ biodataPemilih.ASAL +`</td>
    </tr>
     <tr>
      <td>Keterangan</th>
      <td>`+ waktuMemilih +`</td>
    </tr>
  </tbody>
</table>
</div>`,
  //icon: 'success',
  allowEscapeKey: false,
  allowOutsideClick: false,
  showCancelButton: true,
  confirmButtonColor: '#3085d6',
  cancelButtonColor: '#d33',
  confirmButtonText: '<i class="fa fa-check-square-o" aria-hidden="true"></i> Pilihan Saya',
  cancelButtonText: '<i class="fa fa-power-off" aria-hidden="true"></i> Keluar',
  showDenyButton: true,
  denyButtonText: '<i class="fa fa-bar-chart" aria-hidden="true"></i> Hasil',
  denyButtonColor: '#2ECC71',
  timer: timerLogout,
  timerProgressBar: timerProgressBarLogout,
}).then((result) => {
  if (result.isConfirmed) {
    //console.log(result);
    electionAuth(biodataPemilih);
    $('#dashboard-button').removeClass('d-none');
    $('#logout-button').removeClass('d-none');
    $('#slider').addClass('unlocked')
  } else if (result.isDenied) {
    getHasil(biodataPemilih.ORGANISASI);
    $('#dashboard-button').removeClass('d-none');
    $('#logout-button').removeClass('d-none');
    
  } if (
    result.dismiss === Swal.DismissReason.cancel || result.dismiss === Swal.DismissReason.timer
  ) {
    location.reload();
    
}}) 

  })
  .catch((error) => {

    $(document).ready(function() {
  setTimeout(function() { 
    
$('#div-barcode').html('<svg id="barcode"></svg>');
$("#barcode").JsBarcode(biodataPemilih.KODE, {  height: 40,
});
  }, 1000); // for 5 second delay 
});

if (biodataPemilih.ORGANISASI.toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
 nbmText = 'NBA.';} else {
  nbmText = 'NBA.'
    }

    Swal.fire({
  title: 'Biodata Pemilih',
  html: `<div class="container" id="div-barcode"><div class="spinner-grow" role="status">
  <span class="sr-only">Loading...</span>
</div></div><div class="container table-responsive"> 
<table class="table table-bordered table-hover text-center">
  <tbody>
    <tr>
      <td>Nama</th>
      <td>`+ biodataPemilih.NAMA +`</td>
    </tr>
    <tr>
      <td>NBM/A</th>
      <td>`+ biodataPemilih.NBA +`</td>
    </tr>
    <tr>
      <td>Organisasi</th>
      <td>`+ biodataPemilih.ORGANISASI +`</td>
    </tr>
     <tr>
      <td>Utusan</th>
      <td>`+ biodataPemilih.ASAL +`</td>
    </tr>
     <tr>
      <td>Keterangan</th>
      <td>-</td>
    </tr>
  </tbody>
</table>
</div>`,
  //icon: 'success',
  allowEscapeKey: false,
  allowOutsideClick: false,
  showCancelButton: true,
  confirmButtonColor: '#3085d6',
  cancelButtonColor: '#d33',
  confirmButtonText: '<i class="fa fa-check-square-o" aria-hidden="true"></i> Lanjutkan',
  cancelButtonText: '<i class="fa fa-power-off"></i> Keluar',

}).then((result) => {
  if (result.isConfirmed) {
    electionAuth(biodataPemilih);
    $('#dashboard-button').removeClass('d-none');
    $('#logout-button').removeClass('d-none');
    $('#slider').addClass('inactive')


  } else if (
    /* Read more about handling dismissals below */
    result.dismiss === Swal.DismissReason.cancel
  ) {
    location.reload();
}}) 

  });

}

function loginAlert() {

var biodataPemilih = [];

const { value: text } = Swal.fire({
  title: 'Masukkan Kode Pemilih',
  input: 'text',
  inputLabel: 'Kode Pemilih Anda',
  allowEscapeKey: false,
  footer: `<div class="container">
    <div class="row">
      <div class="form-check form-switch m-3">
      <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="true" aria-controls="collapseExample" checked>
      </div>
      </div>
    <div class="row">
      <div class="collapse show" id="collapseExample">
        <div class="simple-keyboard"></div>
      </div>
    </div>
    </div>`,
  customClass: {
    input: 'input text-uppercase',
  },
  confirmButtonText: '<i class="fa fa-check" aria-hidden="true"></i> Validasi',
  
  inputValidator: (value) => {
    if (!value) {
      return 'Silahkan masukkan kode pemilih!'
    } 
  },
  showLoaderOnConfirm: true,

  preConfirm: (value) => {
    return fetch(`https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/PEMILIH`)
    .then((response) => response.json()).then((data) => {
    var pemilih = data.find( ({ KODE }) => KODE === value.toUpperCase() );
    biodataPemilih = pemilih;
    document.getElementById("kode-pemilih").value = value.toUpperCase();
    document.getElementById("organisasi").value = biodataPemilih.ORGANISASI;
    //console.log(biodataPemilih);
    if (typeof pemilih == 'undefined') {
      throw new Error(response.statusText)
        } 
        //console.log('sukses');
        return pemilih;
      })
      .catch(error => {
        Swal.showValidationMessage(
          //`Request failed: ${error}`
          'Kode pemilih tidak ditemukan!'
        )
      })
  },
  allowOutsideClick: false,
}).then((result) => {
  if (result.isConfirmed) {

    goDashboard(biodataPemilih);
    
  }
})



//let Keyboard = window.SimpleKeyboard.default;

//let keyboard = new Keyboard({
//  onChange: input => onChange(input),
//  onKeyPress: button => onKeyPress(button),
//  mergeDisplay: true,
//  layoutName: "default",
//  layout: {
//    default: [
//    "1 2 3 4 5 6 7 8 9 0",
//    "Q W E R T Y U I O P",
//      "A S D F G H J K L",
//      "Z X C V B N M {backspace}",
//    ]
//  },
//  display: {
//    "{numbers}": "123",
//    "{ent}": "return",
//    "{escape}": "esc ⎋",
//    "{tab}": "tab ⇥",
//    "{backspace}": "backspace",
//    "{capslock}": "caps lock ⇪",
//    "{shift}": "⇧",
//    "{controlleft}": "ctrl ⌃",
//    "{controlright}": "ctrl ⌃",
//    "{altleft}": "alt ⌥",
//    "{altright}": "alt ⌥",
//    "{metaleft}": "cmd ⌘",
//    "{metaright}": "cmd ⌘",
//    "{abc}": "ABC"
//  }
//});

document.querySelector(".input").addEventListener("input", event => {
  keyboard.setInput(event.target.value);
});

function onChange(input) {
  document.querySelector(".input").value = input;
  console.log("Input changed", input);
}

function onKeyPress(button) {
  console.log("Button pressed", button);
  if (button === "{numbers}" || button === "{abc}") handleNumbers();
}

function handleNumbers() {
  let currentLayout = keyboard.options.layoutName;
  let numbersToggle = currentLayout !== "numbers" ? "numbers" : "default";

  keyboard.setOptions({
    layoutName: numbersToggle
  });
}

}



var semuapilihan = [];

function electionAuth(biodataPemilih) {

  if (biodataPemilih.ORGANISASI.toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
 must = jumlahPilihanMu; } else {
  must = jumlahPilihanAi;
    }


  $('#election-section').removeClass('d-none');
var myDiv = document.getElementById("daftar-pilihan");
var userInfo = document.getElementById("user-info");

userInfo.innerHTML = "Anda memilih sebagai "+ biodataPemilih.NAMA;
$('#election-section').removeClass('d-none');
$('#indicator-navbar').removeClass('invisible');
$('#election-submit').removeClass('invisible');
$('#title').html(`<h4>Daftar Calon Formatur Pimpinan Cabang `+ biodataPemilih.ORGANISASI +` WULUHAN</h4><h4>Periode 2024-2026</h4>`);
$('#indicator-text').html("Anda memilih 0 dari "+ must)

fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/PILIHAN")
  .then((response) => response.json())
  .then((data) => {
   // var pilihan = data.find( ({ KODE }) => KODE === pilihan );
   // document.getElementById("nama-pilihan-pemilh").innerHTML = pilihan['NAMA'];

   const filterOrg = {
  "ORGANISASI": biodataPemilih.ORGANISASI,
}

const filteredOutput = data.filter( obj => {
  return Object.keys(filterOrg).every( filterKeys => {
    return obj[filterKeys] === filterOrg[filterKeys]
  });
});


   var data = filteredOutput.sort((a, b) => Number(a.URUT) - Number(b.URUT));
   myDiv.innerHTML = "";




   for (var i = 0; i < data.length; i++) {
    var div = document.createElement("div");
    var label = document.createElement("label");
    var urut = document.createElement("div");
    var img = document.createElement("img");
    var checkBox = document.createElement("input");
    var icheck = document.createElement("i");
    var nama = document.createElement("div");
    var nbm = document.createElement("div");
    
    div.className = "col-lg-2 col-xs-4 text-center";
    //div.style = "border-style: solid;";
    label.className = "image-checkbox position-relative bg-white locked";
    //label.style = "height: 200px";
    urut.className = "text-center";
    urut.innerHTML = `<span class="fw-bold">`+data[i].URUT+`</span>`;
    img.className = "img-thumbnail grayscale";
    img.style = "aspect-ratio: 1 / 1; object-fit: cover; width:250px";
    img.src = data[i].FOTO;

if (biodataPemilih.ORGANISASI.toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {
  img.onerror = function(){
    this.onerror = null;
    this.src = 'foto-mu.png'
};
} else {
  img.onerror = function(){
    this.onerror = null;
    this.src = 'foto-ai.png'
};
    }

    checkBox.type = "checkbox";
    checkBox.value = data[i].KODE;
    checkBox.name = data[i].KODE;
    checkBox.disabled = true;
   // checkBox.checked = true;
    //div.className = "image-checkbox-checked";
    icheck.className = "fa fa-check hidden";
    //nama.style = "text-overflow: ellipsis;overflow: hidden;white-space: nowrap;";
    nama.innerHTML = `<span class="fw-bold">`+data[i].NAMA+`</span>`;

    if (data[i].ORGANISASI.toUpperCase() == 'IKATAN PELAJAR MUHAMMADIYAH') {nbm.innerHTML = "NBA. " + data[i].NBM;} else {
      nbm.innerHTML = "NBA. " + data[i].NBM;
    }
    
    

   
    myDiv.appendChild(div);
    
    div.appendChild(label);
    label.appendChild(urut);    
label.appendChild(img);
label.appendChild(checkBox);
label.appendChild(icheck);
label.appendChild(nama);
//label.appendChild(nbm);

if (semuapilihan.some(item => item == checkBox.value)) {
      checkBox.checked = true;
      label.className = "image-checkbox image-checkbox-checked position-relative locked";
      img.className = "img-thumbnail";
    }

    validPilihan()
}


// sync the state to the input
$(".image-checkbox").on("click", function (e) {
  if (!$(this).hasClass('locked')) { 

  $(".image-checkbox2").each(function(){
		$(this).find('input[type="checkbox"]').removeAttr("checked");
    $(this).find('input[type="checkbox"]').checked = false;
		$(this).removeClass('image-checkbox-checked2');
	});

  $(this).toggleClass('image-checkbox-checked');
  $(this).find('img').toggleClass('grayscale');

  var $checkbox = $(this).find('input[type="checkbox"]');
  $checkbox.checked = true;
  $checkbox.prop("checked",!$checkbox.prop("checked"))

  if ($('.image-checkbox-checked').length > must) {
    $(this).find('input[type="checkbox"]').removeAttr("checked");
    $(this).find('input[type="checkbox"]').checked = false;
    $(this).removeClass('image-checkbox-checked');
    $(this).find('img').addClass('grayscale');

    Swal.fire({
  icon: 'error',
  title: 'Oops...',
  text: 'Maaf, Anda hanya boleh memilih maksimal '+must,
  //footer: '<a href="">Why do I have this issue?</a>'
})

}
}

  e.preventDefault();
  validPilihan()
});

  })
  .catch((error) => {
    console.error(error);
  });
  

}

function validPilihan() {
var indiNavbar = document.getElementById("indicator-navbar");
var indiProgress = document.getElementById("indicator-progress");
var indiText = document.getElementById("indicator-text");
var sliderButton = document.getElementById("slider");
var length = $('.image-checkbox-checked').length;
var percent = (length / must) * 100;
var kurang = must - length;

if ($('#slider').hasClass('unlocked')) {
    $('.image-checkbox').addClass('locked');
    $('.image-checkbox').find('input[type="checkbox"]').attr('disabled', true);
    indiText.innerHTML = "Anda memilih " + length + " dari "+ must;
    indiProgress.innerHTML = "Sudah cukup";
    indiProgress.style = "width:100%; background-color: #27AE60"
    indiNavbar.style = "background-color: #ABEBC6";
  } else  if (length < must) {
    $('.image-checkbox').removeClass('locked');
    $('.image-checkbox').find('input[type="checkbox"]').removeAttr('disabled');
    indiText.innerHTML = "Anda memilih " + length + " dari "+ must;
    indiProgress.innerHTML = "Belum cukup, kurang " + kurang;
    indiProgress.style = "width:"+ percent +"%; background-color: #F39C12";
    indiNavbar.style = "background-color: #F9E79F";
    sliderButton.className = "inactive";
  } else {
    $('.image-checkbox').removeClass('locked');
    $('.image-checkbox').find('input[type="checkbox"]').removeAttr('disabled');
    indiText.innerHTML = "Anda memilih " + length + " dari "+ must;
    indiProgress.innerHTML = "Sudah cukup";
    indiProgress.style = "width:100%; background-color: #27AE60"
    indiNavbar.style = "background-color: #ABEBC6";
    sliderButton.className = "active";
  }


}

function infoPilihan() {

    var getKodePilihan = document.getElementById("pilihan").value;

    fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/PILIHAN")
  .then((response) => response.json())
  .then((data) => {
    var pilihan = data.find( ({ KODE }) => KODE === getKodePilihan );


   document.getElementById("kode-pilihan").innerHTML = pilihan['KODE'];
   document.getElementById("nama-pilihan").innerHTML = pilihan['NAMA'];
   document.getElementById("nbm-pilihan").innerHTML = pilihan['NBM'];
   //document.getElementById("foto-pilihan").innerHTML = pilihan['FOTO'];

   var image = document.createElement("img");
image.id = "id";
image.className = "class";
image.src = pilihan['FOTO'];



document.getElementById("foto-pilihan").innerHTML = "";
document.getElementById("foto-pilihan").appendChild(image);
    

  })
  .catch((error) => {
    console.error(error);
  });

}

function submitAuth() {
  Swal.fire({
    icon: 'question',
  title: 'Apakah Anda yakin?',
  //showDenyButton: true,
  showCancelButton: true,
  confirmButtonText: 'Yakin',
  cancelButtonText: 'Kembali',
  //denyButtonText: `Don't save`,
}).then((result) => {
  /* Read more about isConfirmed, isDenied below */
  if (result.isConfirmed) {
    addPilihan();
    Swal.fire('Saved!', '', 'success');
  }
})
}

function editPilihan() {
  moment.locale('id');
  var getkodePemilih = document.getElementById("kode-pemilih").value;
  var getOrganisasi = document.getElementById("organisasi").value;
  var kodePilihan = []

  $(".image-checkbox-checked").find("input:checked").each(function (i, ob) { 
      kodePilihan.push($(ob).val());
});
  
    fetch(
  "https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/PEMILIH/*"+ getkodePemilih +"*",
  {
    method: "PATCH",
    mode: "cors",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      "WAKTU": moment().format('DD MMM YYYY HH.mm'),
      "ORGANISASI": getOrganisasi,
      "PEMILIH": getkodePemilih,
      "PILIHAN1": kodePilihan[0],
      "PILIHAN2": kodePilihan[1],
      "PILIHAN3": kodePilihan[2],
      "PILIHAN4": kodePilihan[3],
      "PILIHAN5": kodePilihan[4],
      "PILIHAN6": kodePilihan[5],
      "PILIHAN7": kodePilihan[6],
      "PILIHAN8": kodePilihan[7],
      "PILIHAN9": kodePilihan[8],
    }),
  }
)
  .then((r) => r.json())
  .then((data) => {
    console.log(data);
    if (data.length == 0) {
       addPilihan() 
    } else {
      //location.reload();


      Swal.fire({
  title: 'Berhasil',
  text: 'Pilihan Anda telah tersimpan!',
  icon: 'success',
  allowEscapeKey: false,
  allowOutsideClick: false,
  showConfirmButton: false,
  timer: 5000,
  timerProgressBar: true,
}).then((result) => {
  if (result.dismiss === Swal.DismissReason.timer) {
    console.log('I was closed by the timer');
    goDashboard();
  }})


validPilihan();
    }

})
  .catch((error) => {
    // Errors are reported there
    console.log(error);
  });


}

function addPilihan() { 
    moment.locale('id'); 
    var getkodePemilih = document.getElementById("kode-pemilih").value;
    var getOrganisasi = document.getElementById("organisasi").value;
    var kodePilihan = []

    $(".image-checkbox-checked").find("input:checked").each(function (i, ob) { 
      kodePilihan.push($(ob).val());
});


  fetch("https://sheet.best/api/sheets/4c553cb4-04ac-4604-b8f0-a8671aea4193/tabs/DATA", {
  method: "POST",
  mode: "cors",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    "WAKTU": moment().format('DD MMM YYYY HH.mm'),
      "ORGANISASI": getOrganisasi,
      "PEMILIH": getkodePemilih,
      "PILIHAN1": kodePilihan[0],
      "PILIHAN2": kodePilihan[1],
      "PILIHAN3": kodePilihan[2],
      "PILIHAN4": kodePilihan[3],
      "PILIHAN5": kodePilihan[4],
      "PILIHAN6": kodePilihan[5],
      "PILIHAN7": kodePilihan[6],
      "PILIHAN8": kodePilihan[7],
      "PILIHAN9": kodePilihan[8],
    }),
})
  .then((r) => r.json())
  .then((data) => {
    // The response comes here
    Swal.fire({
  title: 'Berhasil',
  text: 'Pilihan Anda telah tersimpan!',
  icon: 'success',
  allowEscapeKey: false,
  allowOutsideClick: false,
  showConfirmButton: false,
  timer: 5000,
  timerProgressBar: true,
}).then((result) => {
  if (result.dismiss === Swal.DismissReason.timer) {
    console.log('I was closed by the timer');
    goDashboard();
  }})
    
validPilihan();
  })
  .catch((error) => {
    // Errors are reported there
    console.log(error);
  });
}

</script>

</html> 
